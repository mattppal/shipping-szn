# Cursor Rules for CCC (Changelog Creation & Coordination)

## Project Overview

Python-based multi-agent system using Claude Agent SDK to orchestrate changelog creation, formatting, review, and GitHub PR submission.

**Tech Stack:** Python 3.13+, `uv` package manager, `claude-agent-sdk`, `pygithub`, `slack-sdk`, `pytest`, `black`

## Code Style

### Python Standards

- **Formatting:** Use Black (88 char line length, configured in pyproject.toml)
- **Type hints:** Include for function parameters and returns: `def func(param: str) -> dict:`
- **Strings:** Double quotes consistently, prefer f-strings
- **Imports:** Group as standard library → third-party → local. Use absolute imports: `from servers.config import MCP_SERVERS`
- **Environment:** Load `dotenv` at module top: `load_dotenv()` before `os.getenv()`

### Async Patterns

```python
# Entry point
async def main():
    async with ClaudeSDKClient(options=options) as client:
        await client.query(prompt=USER_PROMPT)
        async for message in client.receive_response():
            display_message(message)

asyncio.run(main())
```

### Naming Conventions
- **Functions:** `snake_case` (e.g., `fetch_messages_from_channel`)
- **Classes:** `PascalCase` (e.g., `AgentDefinition`)
- **Constants:** `UPPER_SNAKE_CASE` (e.g., `GITHUB_TOKEN`)
- **Agent names:** Match role: `changelog_writer`, `template_formatter`, `pr_writer`

### Error Handling
- Use specific exceptions: `GithubException`, `ValueError`
- Validate env vars at module load: `if not GITHUB_TOKEN: raise ValueError("GITHUB_TOKEN not set")`
- Log with context: `logger.error(f"Error uploading {file_path}: {str(e)}")`
- Never expose secrets in errors

## Project Structure

```text
ccc/
├── main.py                 # Orchestrator with agent definitions
├── servers/                # MCP server tools
│   ├── config.py          # MCP_SERVERS configuration
│   ├── github_tools.py    # GitHub API tools (@tool decorator)
│   └── slack_tools.py     # Slack API tools (@tool decorator)
├── util/                  # Utilities
│   └── messages.py        # Message display for agent responses
├── prompts/               # Agent context and guidelines
│   ├── brand_guidelines.md
│   ├── changelog_template.md
│   ├── docs_style_guide.md
│   └── good_docs.md
├── docs/updates/          # Generated changelogs (YYYY-MM-DD.md)
└── test/                  # Pytest tests (test_*.py)
```

**File placement:**

- Tools → `servers/`
- Utilities → `util/`
- Agent prompts → `prompts/`
- Changelogs → `docs/updates/YYYY-MM-DD.md`
- Media → `docs/updates/media/YYYY-MM-DD/`

## Claude Agent SDK Patterns

### Tool Implementation

```python
from claude_agent_sdk import tool

@tool
def my_tool(param: str) -> dict:
    """Clear description of tool behavior.
    
    Args:
        param: Description
        
    Returns:
        dict with 'result' or 'error' keys
    """
    try:
        # Implementation
        return {"result": "value", "is_error": False}
    except Exception as e:
        return {"error": str(e), "is_error": True}
```

**Requirements:**

- Use `@tool` decorator
- Return dict with `is_error` boolean
- Include comprehensive docstrings
- Handle errors gracefully

### Agent Definition Pattern

```python
AgentDefinition(
    description="One-line agent purpose for routing",
    prompt=f"""
    Role and responsibilities
    
    Context: {dynamic_context}
    
    Tools: {list available tools}
    
    <guidelines>
        {open('./prompts/relevant_guide.md').read()}
    </guidelines>
    """,
    model="sonnet",  # or "haiku" for simpler tasks
    tools=permission_groups["agent_name"],
)
```

**Model selection:**

- `sonnet`: Complex tasks (changelog_writer, template_formatter)
- `haiku`: Simpler tasks (review_and_feedback, pr_writer)

### MCP Server Configuration

```python
# In servers/config.py
from claude_agent_sdk import create_sdk_mcp_server
from claude_agent_sdk.types import McpHttpServerConfig

MCP_SERVERS = {
    "custom_tools": create_sdk_mcp_server(
        name="server_name",
        tools=[tool_function1, tool_function2]
    ),
    "external_api": McpHttpServerConfig(
        type="http",
        url="https://api.example.com/mcp",
        headers={"Authorization": f"Bearer {token}"}
    ),
}
```

### Permission Management
```python
# Define granular permissions
permissions = {
    "read_docs": "Read(./docs/**/*)",
    "write_docs": "Write(./docs/**/*)",
}

# Group by agent role
permission_groups = {
    "agent_name": [
        permissions["read_docs"],
        permissions["write_docs"],
    ],
}

# In ClaudeAgentOptions
permission_mode="bypassPermissions",  # TODO: Change to "explicit" for production
```

**Note:** Currently using `bypassPermissions` for development. Switch to `"explicit"` for production security (see ARCHITECTURE_REVIEW.md).

### Orchestrator Pattern

```python
options = ClaudeAgentOptions(
    agents={...},  # Dictionary of AgentDefinition objects
    system_prompt="Professional context",
    permission_mode="bypassPermissions",
    model=os.getenv("ORCHESTRATOR_MODEL"),
    cwd="./",
    mcp_servers=MCP_SERVERS,
)
```

## Documentation & Content Standards

### Changelog File Format

- **Path:** `./docs/updates/YYYY-MM-DD.md`

- **Frontmatter:**

```markdown
---
title: October 30, 2025
description: 2 min read
---

import { AuthorCard } from '/snippets/author-card.mdx';

<AuthorCard/>
```
- **Structure:**

  - `## Platform updates` (bullet summary, then `### [Update Name]` sections)
  - `## Teams and Enterprise` (same structure)

- **Images:** Use `/images/changelog/YYYY-MM-DD/filename` (not `./media/...`)
- **Links:** Relative paths only, descriptive text (never "click here")

### Brand Voice Rules

- **Person:** Second person ("you"), never first person plural ("we")
- **Products:** Capitalize Replit products (Agent, Assistant, Visual Editor, Workspace)
- **Terminology:** "publishing" not "deployment" (except deployment types in advanced settings)
- **Headings:** Sentence case
- **Numbers:** Spell out 0-9, use numerals for 10+
- **Commas:** Always use Oxford commas
- **Em-dashes:** Use — without spaces

### Documentation Style (Mintlify)
- Active voice, present tense, imperative mood
- Sentences under 25 words
- `monospace` for code/file names/commands
- **Bold** for UI elements and key terms on first use
- `<img>` tags with descriptive alt text
- No "click here" links

## Testing Patterns

### Test Structure
```python
#!/usr/bin/env python3
"""Test description."""

import os
from dotenv import load_dotenv

load_dotenv()

def test_feature_name():
    """Test specific behavior."""
    # Arrange
    # Act
    # Assert
```

**Test files:** `test/test_<module_name>.py`

**Best practices:**

- Load env vars at module level
- Descriptive test names
- Mock external API calls
- Test success and error cases

## Security & Validation

### Environment Variables

- **Never commit** `.env` files
- Validate required vars: `if not GITHUB_TOKEN: raise ValueError(...)`
- Use descriptive names: `GITHUB_TOKEN`, `SLACK_CHANNEL_ID`, `GITHUB_REPO`

### File Path Validation
- Always validate before file operations
- Use relative paths: `./docs/updates/...`
- Prevent traversal: Validate paths don't escape allowed directories
- Parse dates from paths: Use regex (see `parse_changelog_path()` in `github_tools.py`)

### GitHub Operations
- Validate changelog content before PR creation
- Use draft PRs for automated changelogs
- Include review checklist in PR description
- Auto-add labels: `bot`, `automated-pr`, `needs-review`, `changelog`

## Common Utilities

### Date Handling
```python
from datetime import datetime

# File names
date_str = datetime.now().strftime("%Y-%m-%d")  # "2025-10-30"

# Display
display_date = datetime.strptime(date_str, "%Y-%m-%d").strftime("%b %d, %Y")  # "Oct 30, 2025"
```

### Branch Naming

Format: `{prefix}/{timestamp}` (e.g., `changelog/20251030-143022`)

### Logging

```python
import logging
logger = logging.getLogger(__name__)
logger.info(f"Operation: {context}")
logger.error(f"Error: {error_message}")
```

## Anti-Patterns

**Don't:**

- ❌ Clone repositories (create files locally, use GitHub MCP)
- ❌ Hardcode paths (use relative from project root)
- ❌ Skip env var validation
- ❌ Expose tokens in logs/errors
- ❌ Use "we" (use "you")
- ❌ Capitalize generic terms (only Replit products)
- ❌ Write outside `./docs/updates/`
- ❌ Create PRs without validation
- ❌ Use absolute URLs in docs
- ❌ Bypass permissions without reason

## Development Workflow

1. Review existing patterns and agent prompts
2. Follow style guide (Black, type hints, docstrings)
3. Write tests for new functionality
4. Update relevant prompts if agent behavior changes
5. Ensure security, correctness, pattern adherence

## Architecture Notes

**Workflow:** Orchestrator → changelog_writer → template_formatter → review_and_feedback → pr_writer

**Permission mode:** Currently `bypassPermissions`. Change to `"explicit"` for production (see ARCHITECTURE_REVIEW.md).

**Agent models:**

- Complex work: `sonnet` (changelog_writer, template_formatter)
- Simple work: `haiku` (review_and_feedback, pr_writer)
